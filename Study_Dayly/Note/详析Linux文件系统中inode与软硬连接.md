Linux的文件操作, 都是从内存文件进行操作, 即都是对打开的文件进行操作的.

但是, 我们的操作系统中并不是只有内存文件的, 甚至可以说 `内存文件只是操作系统中所有文件的一小部分, 绝大部分的文件都是处于未打开的状态的`. 这些文件一般都静静的在磁盘中存储着, 所以也被称为**`磁盘文件`**

本片文章的主要内容就是介绍Linux的文件系统是怎么管理磁盘文件的.

# 磁盘相关信息

在介绍 Linux的文件系统之前, 至少要先了解一下磁盘是什么样的、大概有什么结构？不然怎么进一步理解 文件系统呢？

## 磁盘的物理结构

<img src="https://dxyt-july-image.oss-cn-beijing.aliyuncs.com/CSDN/image-20230320145023027.png" alt="image-20230320145023027" width="60%" />

这就是一个磁盘, 上面的圆盘叫做`磁盘盘片`, 悬在盘片上的像针一样的东西叫`磁头`, 磁盘中间的部分叫`主轴`, 磁头链接着`磁头臂`, 磁头臂被一个`传动轴`连接着：

<img src="https://dxyt-july-image.oss-cn-beijing.aliyuncs.com/CSDN/image-20230320150109444.png" alt="image-20230320150109444" width="60%" />

其中, 主轴下方是轴承和马达, 可以带动`盘片旋转`, 传动轴则可以让`磁头臂左右摆动`, 即 磁盘内部的机械结构是类似这样运动的：

<img src="https://dxyt-july-image.oss-cn-beijing.aliyuncs.com/CSDN/image-20230320151903616.png" alt="image-20230320151903616" width="60%" />

![磁盘机械运动](https://dxyt-july-image.oss-cn-beijing.aliyuncs.com/CSDN/%E7%A3%81%E7%9B%98%E6%9C%BA%E6%A2%B0%E8%BF%90%E5%8A%A8.gif)

并且, 一个磁盘中可能有上下排列有许多的盘片, 并且每个盘片上下都有6一个磁头, 类似这样：

<img src="https://dxyt-july-image.oss-cn-beijing.aliyuncs.com/CSDN/image-20230320152927464.png" alt="image-20230320152927464" style="zoom:67%;" /> <img src="https://dxyt-july-image.oss-cn-beijing.aliyuncs.com/CSDN/image-20230320153121768.png" alt="image-20230320153121768" style="zoom:67%;" />

## 磁盘的存储结构

上面大致的介绍了一下磁盘的物理结构, 知道了磁盘的机械结构可能由多个盘片和多个磁头臂+磁头组成

这两个结构可以说是磁盘最重要的结构之二.

那么数据在磁盘的什么地方存储呢？

其实**`数据都在盘片上存储着, 而磁头负责从盘片上读取或向盘片上写入数据`**

1. ### 盘片是怎么存储数据的？

  其实光滑的`盘片上可以看作有无数个同心圆`, 图片表示就类似这样：

  <img src="https://dxyt-july-image.oss-cn-beijing.aliyuncs.com/CSDN/image-20230320163807230.png" alt="image-20230320163807230" style="zoom:50%;" />

  不过这些`圆在盘片上被称为磁道`, 而`每个磁道又会被分为许多的的扇区`：

  <img src="https://dxyt-july-image.oss-cn-beijing.aliyuncs.com/CSDN/image-20230320171338786.png" alt="image-20230320171338786" style="zoom:45%;" />

  > **==这只是抽象图, 并不确切表示盘片中磁道和扇区的数量==**

  `数据就在这些磁道中以二进制的形式存储着`

  并且, 每条磁道都有自己的编号, `最外层磁道的编号为0`; 每条磁道上的每块扇区也有自己的编号, `每块扇区的大小一般为512字节`

  **`每条磁道的扇区数是相同的, 每块扇区的大小也是相同的, 这也就意味着每条磁道的可存储数据的大小其实也是相同的`**

  很明显`越外层的磁道越长, 长磁道与短磁道可存储数据的大小也是相同的吗？是的`, 每条磁道存储数据的密度不相同

2. ### 磁盘是通过什么来读取或写入数据的呢？

  既然数据在磁道中存储着, 那么就肯定要从磁道中读取数据 或 向磁道中写入数据

  那么磁盘是通过什么来进行此操作的呢？

  没错, 就是`通过磁头`

  **`盘片的旋转结合磁头的左右摆动, 可以使磁头悬浮于盘片的任意位置, 也就是说磁头可以通过一定的操作在盘片的任意位置读取数据或写入数据`**

  > 盘片在高速旋转时不能接触到任何物体, 不然盘片就会发生损伤
  >
  > 所以磁头一般是悬浮在盘片上下的
  >
  > 磁头通过感应盘片上的磁场变化来读取数据, 通过改变盘片上的磁场来写入数据
  >
  > (磁场分为NS, 正好对应二进制的01)

  **==磁盘中可能存在多个水平但上下放置的盘片, 那么这些盘片必定会存在相同半径的磁道同处于同一个圆柱面上, 这个圆柱面我们就称之为磁柱(Cylinder):==**

  <img src="https://dxyt-july-image.oss-cn-beijing.aliyuncs.com/CSDN/image-20230320183616381.png" alt="image-20230320183616381" style="zoom:80%;" />

  **`磁柱是Cylinder, 磁头是Head, 扇区是Sector`**, 当我们知道这三个结构的编号, 就能`在磁盘中定位到一个指定的扇区`

  知道磁柱的编号就确定了`磁道的编号`, 磁头可以`确定哪个盘面`, 扇区编号可以知道`扇区在磁道中的位置`, 知道这三个编号, 就能`确定到某个盘片上的某条磁道上的某块扇区, 也就知道了当前访问的扇区`

  这样的地址被称为**`CHS地址`**, 用这样的方法, 可以找到磁盘中每个单元的确切位置

3. ### 磁盘存储结构的逻辑抽象

	经过上面介绍了磁盘的物理结构 和 存储结构之后, 其实数据就是存储在一个一个圆圈上的. 也可以看作是线性存储的

	毕竟圆圈是可以拉直的

	就像磁带一样, 卷在一起的时候可以看作是数据存储在一个一个圆圈上, 当把磁带拉直也可以看作数据是存储在一条直线上. 不管是卷起来还是拉直, 其实都没有损坏磁带, 更没有损坏磁带上的数据.

	<img src="https://dxyt-july-image.oss-cn-beijing.aliyuncs.com/CSDN/image-20230320225821020.png" alt="image-20230320225821020" style="zoom:80%;" />

	那么其实, 磁盘上的盘片上的磁带也可以抽象成这样的直线的、线性的形式, `作为一个数组被管理起来`

	即, 磁盘上的所有盘片的所有磁道都可以抽象成一个线性的数组然后整合起来：

	<img src="https://dxyt-july-image.oss-cn-beijing.aliyuncs.com/CSDN/image-20230320232237424.png" alt="image-20230320232237424" style="zoom:80%;" />

	所有的扇区被整合成一个数组, 每个下标对应着一个扇区, 即可以根据数组的下标来定位到磁盘中的某个扇区, 这里的下标被叫做`LBA逻辑块地址`

	**`通过LBA是可以计算出相对应的CHS的`**, 比如：

	已知磁盘上每个盘片上有100条磁道, 每条磁道20个扇区, 当我们获得一个LBA是9231. 我们就可以根据9231来计算出对应的CHS：

	9231表示第9231个扇区, 每个盘片100个磁道, 每个磁道20个扇区, 即每个盘片2000个扇区：

	9231/2000 -> 第5个面盘上(Head), 9231%2000 = 第1231个扇区, 1231/20 -> 第62条磁道上(C), 1231%20 = 11个扇区(S)

	即, `LBA=9231 对应的CHS为 62:5:11`

# 文件系统

我们了解了磁盘的物理存储结构, 并理解了可以将磁盘的存储结构抽象成一个数组来进行管理

对于抽象出来的数组, 每个单元对应着一个扇区, 但是`一般来说操作系统与磁盘进行I/O操作的基本单位是4KB`. 即, 实际上对操作系统来说, 还可以`将抽象出来的一个单元对应一个扇区的数组, 进一步划分一下, 以8个单元为一个大的单元`, 即 8*512B = 4KB, `以便于操作系统与磁盘实际进行I/O操作` 

> 为什么不将操作系统与磁盘的I/O操作的基本单位 直接设置为一个扇区, 而是固定设置成4KB呢？
>
> 1. `对大多数的磁盘`来说, 一个扇区一个扇区的IO太慢了, 设置成4KB是`为了提高IO效率`
>
> 2. 不让软件设计和硬件具有强相关性, 在此, 就是不让操作系统和磁盘之间在IO方面具有强相关性
>
> 	因为, 如果操作系统与磁盘的IO单位是按照当前磁盘设计的话, 那么针对不同型号、扇区大小不同的磁盘时, 操作系统就需要做出相应的修改, 这个过程是复杂且繁琐的. 而如果将操作系统与硬件的IO基本单位设置成一个固定的值, 就不需要根据硬件去作出修改. 这也就是软件设计中常说的, `解耦合`

不过, 即使将磁盘的存储结构抽象成了数组, 如果操作系统直接对整个数组进行管理, 你会发现也是非常困难的.

就拿一个最普通的512GB的磁盘来说, 每个扇区的大小是512字节, 那么若数组的每个单元表示一个扇区, 那么整个数组需要多大？再以8个扇区为一个单元的数组又有多大？

分别是`1,073,741,824` 和 `134,217,728`, 即使后者比前者小了一个数量级, 但依旧是千万级的

让操作系统直接一下子管理着千万级的数组, 会不会太离谱了？即使操作系统可以管理, 但是直接管理千万级的数组, 成本是否太大了？

所以, 操作系统是不会直接对整个磁盘的数组进行管理的, 而是`会针对磁盘的不同分区, 将分区分为不同的组, 再针对组进行管理.`

对细分出来的组的管理 相比 直接对整个磁盘抽象出来的数组的管理, 一定是简单的不少的！并且, `对于像组, 这种属性基本相同的结构来说, 管理好一个组, 就可以管理好其他所有的组` 

即：

![image-20230321015206958](https://dxyt-july-image.oss-cn-beijing.aliyuncs.com/CSDN/image-20230321015206958.png)

对分区进行分组之后, 每个组内都会某些相同作用的块或属性：`Super Block` `Group Descriptor Table` `Block Bitmap` `inode Bitmap` `indoe Table` `Data blocks`



